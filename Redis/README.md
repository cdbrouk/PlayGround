# 2021.01.16

## 회사에서 Redis 관련 백엔드 작업하면서 정리

특정 타입별, 특정 기간에 대한 포스트 조회수에 대해 순위 데이터를 유지해야 할 일이 생겼다.

첨엔 Redis를 잘몰랐어서 어떻게 할까 고민 끝에 내린 방법은

> 1. Redis에 id, type, date, count를 저장
> 2. 특정 주기 별로 Redis데이터를 DB에 업데이트 (이렇게 하면 DB 쿼리 횟수가 줄어서 조금은 나을까 싶었당..)
> 3. 특정 주기별로 DB 쿼리가 순위를 계산하고 결과 리스트를 Redis에 다시 저장

이렇게 Redis와 DB를 병행해서 하려고 했다!

하지만 DB에 계속 유지될 필요가 없는 데이터라고 하고, CTO님이 알려주신 키워드로 찾아보니

Redis에는 애초에 Data를 Sorted하여 저장해둘 수 있는 방법이 있었다...!!

게다가 오름차순, 내림차순, LIMIT 등등..그전까지는 단순한 key value만 넣어두는 메모리 DB라

생각했었는데.. 무지함을 느낀 순간이었다..ㅠ

다시 공식 Docs를 읽어 가면서 다시 구현한 구조는 이렇다!

> 1. 특정 database의 index를 조회수 용도로 사용하기로 결정!
> 2. zincrby를 이용해서 요청 때마다 조회수를 늘려주자! key = type, increment = 1, member = id 의 형태로 저장했다
> 3. zrevrangebyscore를 이용하여 DESC 정렬을 해서 30개만 뽑아내면 원하는 리스트는 끝!

마지막으로 남은 부분은 Batch를 이용해서 해당 index의 모든 키를 매주 정해진 요일에 날려버리려고 한다. 근데 사실 OS에 Batch 프로그램을 짜는 법을 몰라서..

Lambda의 eventbridge를 이용해서 돌리려 한다. 클라우드 서버에 Batch 심는 법을 그때 CTO님이 뭐라고 알려주셨었는데... 다시 여쭤봐야겠다...

아 참고로 flushdb 할때 async 옵션을 사용하면 별도 쓰레드를 이용해서 백그라운드로 작업을 한다고 한다!! 참고로 알아두자..
